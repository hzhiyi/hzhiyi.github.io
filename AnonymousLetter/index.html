
<!DOCTYPE html>
<html>

	<head>
		<meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
		<title>匿名信</title>
		<link rel="stylesheet" type="text/css" href="css/style.css" />
		<link rel="stylesheet" href="css/mdui.min.css">
        <script src="js/mdui.min.js"></script>
	</head>
    
	<body background="image/bk.jpg">
		<body class="mdui-theme-primary-blue">
			<div class="mdui-toolbar mdui-color-theme mdui-appbar-fixed">
				<span class="mdui-typo-title">匿名信</span>
				<div class="mdui-toolbar-spacer"></div>
			</div>
			<div class="mdui-container" style="margin-left:180px; margin-top:250px">
				<div class="secret-wrap" id="app" v-clock>
					<div class="inp-wrap" >
                        <div class="noExtension" id="noExtension">
                            提示: 请安装
                            <a target="_blank" href="https://github.com/ChengOrangeJu/WebExtensionWallet">WebExtensionWallet</a> 再使用匿名信
                        </div>
                        <hr style="width:50%">
                        <br />
                        <a>有没有写给你的匿名信呢？快来查一查吧！</a>
                        <br />
                        <div>
                            <textarea id="myname" rows="1"  cols="1" placeholder="你的名字" style="float:left;"></textarea>
                            <div >
                                <br />
                                <button style="margin-left:10px; margin-top:2px"  id="mypush" onclick="mypush()" class="mdui-btn mdui-btn-raised mdui-ripple">查一查</button>
                            </div>
                        </div>
                        <br />
                        <br />
						<div id="noone" style="display: none">
							<a >还没有人给你写匿名信哦!试试给别人写一封吧</a>
							<br />
						</div>
                        <div class="item" v-for="(s,index) in list">
                            <div class="img">
                                <img src="image/photo.jpg" alt="" />
                            </div>
                            <div class="user">
                                <div class="info">
                                    <div>
                                        <span class="time" v-html="formatDateTime(s.time)"></span>
                                    </div>
                                </div>
                                <div class="content" v-html="s.value">
                                </div>
                            </div>
                        </div>
						<br/>
						<button class="mdui-btn mdui-btn-raised mdui-ripple mdui-btn-dense" disabled="disabled" id="prePage">上一页</button>
						<button class="mdui-btn mdui-btn-raised mdui-ripple mdui-btn-dense" disabled="disabled" id="nextPage">下一页</button>
     
                        <br />
                        <br />
                        <hr style="width:50%">
                        <br />
                        <a>快来给心爱的他/她写一封匿名信吧!</a>
                        <br />
                        <textarea id="name" rows="1" cols="20" placeholder="写下他/她的名字"></textarea>
                        <br />
						<textarea id="word" rows="5" cols="20" placeholder="写下你想对他/她说的话吧"></textarea>
						<br />
						<button id="push" onclick="push()" class="mdui-btn mdui-btn-raised mdui-ripple">提交</button>
					</div>
				</div>
				<hr style="width:50%">
				<div class="public-copyright">
					<p>匿名信基于星云链主网运行。</p>
					<a href="https://nebulas.io/"><img src="data:image/svg+xml;base64,PHN2ZyBpZD0i5Zu+5bGCXzEiIGRhdGEtbmFtZT0i5Zu+5bGCIDEiIHhtbG5zPSJodHRwOi8vd3d3LnczLm9yZy8yMDAwL3N2ZyIgdmlld0JveD0iMCAwIDIxNCAzMCI+CiAgPGRlZnM+CiAgICA8c3R5bGU+LmNscy0xe2ZpbGwtcnVsZTpldmVub2RkO308L3N0eWxlPgogIDwvZGVmcz4KICA8dGl0bGU+bmViPC90aXRsZT4KICA8cGF0aCBjbGFzcz0iY2xzLTEiCiAgICAgICAgZD0iTTEwOC45MiwyLjVsLTIuNDEsNy4zMmgwbC05LjIsNC42OCw3LjEsMi40OCw0LjU1LDkuNSwyLjQxLTcuMzJoMGw5LjItNC42OEwxMTMuNDYsMTJabS00LjU0LDEzLjYzLTUtMS43Ni4xMS0uMDYsNi42OS0zLjQtMS43Miw1LjIzWm00LjY4LTExLjUxLDMuNiw3LjUzLTcuMywzLjcxWm0tLjI1LDE5Ljc1LTMuMzUtNyw1LjA3LDEuNzZabTkuNTktOS42OUwxMTEsMTguNDVsLTUuMy0xLjg1LjExLS4wNiw3LjM5LTMuNzYsNS4zLDEuODVaIi8+CiAgPHBhdGggY2xhc3M9ImNscy0xIgogICAgICAgIGQ9Ik0xNTUuNDEsMTQuNTZhMiwyLDAsMCwwLC40My0xLjIzVjEyLjE0YTIuMSwyLjEsMCwwLDAtMS40NS0ybDAsMGE0LjkxLDQuOTEsMCwwLDAtMS41NS0uMjVoLTQuOTF2OS43M2g1LjY0YTQuODIsNC44MiwwLDAsMCwxLjU0LS4yNWwuMDYsMGEyLjEsMi4xLDAsMCwwLDEuNDUtMnYtLjg3QTIuMzQsMi4zNCwwLDAsMCwxNTUuNDEsMTQuNTZabS02LjY4LTMuODRoNC4wN2E0LjA3LDQuMDcsMCwwLDEsMS4yOS4yMWwwLDBhMS4yNywxLjI3LDAsMCwxLC44NywxLjJ2MS4xOWExLjEyLDEuMTIsMCwwLDEtLjYxLDFoLTUuNjZabTUuNzIsNC4zOGExLjUxLDEuNTEsMCwwLDEsMS4yOSwxLjQxdi44NGExLjI2LDEuMjYsMCwwLDEtLjg3LDEuMmwtLjA1LDBhNCw0LDAsMCwxLTEuMjkuMjFoLTQuOFYxNS4wOVoiLz4KICA8cG9seWdvbiBjbGFzcz0iY2xzLTEiCiAgICAgICAgICAgcG9pbnRzPSIxMzYuMDcgMTkuNiAxMzYuMDcgMTAuMDUgMTQzLjg4IDEwLjA1IDE0My44OCAxMC44NSAxMzYuODUgMTAuODUgMTM2Ljg1IDE0LjQzIDE0My4xMSAxNC40MyAxNDMuMTEgMTUuMjIgMTM2Ljg1IDE1LjIyIDEzNi44NSAxOC44IDE0NC42NCAxOC44IDE0NC42NCAxOS42IDEzNi4wNyAxOS42Ii8+CiAgPHBvbHlnb24gY2xhc3M9ImNscy0xIgogICAgICAgICAgIHBvaW50cz0iMTI0LjkxIDExLjQ5IDEyNC45MSAxOS40MiAxMjQuMTMgMTkuNDIgMTI0LjEzIDkuNDggMTMxLjk3IDE3Ljk5IDEzMS45NyAxMC4wNyAxMzIuNzYgMTAuMDcgMTMyLjc2IDIwIDEyNC45MSAxMS40OSIvPgogIDxwYXRoIGNsYXNzPSJjbHMtMSIKICAgICAgICBkPSJNMTYzLjY3LDE5LjYyYTQsNCwwLDAsMS0zLjk1LTMuODNWOS44N2guODN2NS45MWEzLjEyLDMuMTIsMCwwLDAsMy4xMiwzaC41OWEzLjEyLDMuMTIsMCwwLDAsMy4xMi0zVjkuODdoLjgzdjUuOTFhNCw0LDAsMCwxLTMuOTQsMy44NFoiLz4KICA8cG9seWdvbiBjbGFzcz0iY2xzLTEiCiAgICAgICAgICAgcG9pbnRzPSIxNzEuODIgMTkuNDIgMTcxLjgyIDEwLjA3IDE3Mi42MSAxMC4wNyAxNzIuNjEgMTguNjQgMTc5LjY5IDE4LjY0IDE3OS42OSAxOS40MiAxNzEuODIgMTkuNDIiLz4KICA8cGF0aCBjbGFzcz0iY2xzLTEiCiAgICAgICAgZD0iTTE5MC4yOCwxOS41M2wtMS4xOC0yLjM1aC01LjU3bC0xLjE4LDIuMzVoLS45bDQuODctOS42Nyw0Ljg2LDkuNjdabS0xLjU4LTMuMTUtMi4zOC00Ljc0LTIuMzgsNC43NFoiLz4KICA8cGF0aCBjbGFzcz0iY2xzLTEiCiAgICAgICAgZD0iTTE5My42NCwxOS40MXYtLjgyaDUuNDZhMy44OSwzLjg5LDAsMCwwLDEuMjItLjIsMS40MywxLjQzLDAsMCwwLC44NC0xLjI2VjE2LjZhMS40MiwxLjQyLDAsMCwwLS44Mi0xLjI0LDQsNCwwLDAsMC0xLjI1LS4yaC0zYTQuNzMsNC43MywwLDAsMS0xLjUyLS4yNUEyLDIsMCwwLDEsMTkzLjI0LDEzVjEyLjJhMiwyLDAsMCwxLDEuMzgtMS44OCw0LjY4LDQuNjgsMCwwLDEsMS41MS0uMjVoNC44MnYuODJoLTQuODJhMy45LDMuOSwwLDAsMC0xLjI1LjIxLDEuMTUsMS4xNSwwLDAsMC0uODEsMS4xVjEzYTEuMTUsMS4xNSwwLDAsMCwuODEsMS4xLDQsNCwwLDAsMCwxLjI2LjIxaDNhNC43Miw0LjcyLDAsMCwxLDEuNDguMjRsLjA5LDBhMi4yNCwyLjI0LDAsMCwxLDEuMzIsMnYuNTVhMi4yNSwyLjI1LDAsMCwxLTEuMzEsMmwtLjA4LDBhNC43NCw0Ljc0LDAsMCwxLTEuNDkuMjRaIi8+CiAgPHBhdGgKICAgIGQ9Ik0xNC44MSwxMy4yMmEyLjYxLDIuNjEsMCwwLDAsLjU1LTEuNzEsMi43OCwyLjc4LDAsMCwwLS4yNS0xLjE4LDIuNDEsMi40MSwwLDAsMC0uNjktLjg4LDIuNjcsMi42NywwLDAsMC0xLS41LDExLjYyLDExLjYyLDAsMCwwLTIuMzMtLjE0SDkuMTh2MTAuM0gxMFYxNC4yNGguOGExMy43MiwxMy43MiwwLDAsMCwyLjYxLS4xOEEyLjM5LDIuMzksMCwwLDAsMTQuODEsMTMuMjJabS0uODgtLjM2YTIuNjMsMi42MywwLDAsMS0yLC41NUgxMFY5LjY2aDEuODhjMS43LDAsMi41Ni42MiwyLjU2LDEuODVBMS45MiwxLjkyLDAsMCwxLDEzLjkzLDEyLjg2WiIvPgogIDxwYXRoCiAgICBkPSJNMjMuNTgsMTIuNTJhMy43LDMuNywwLDAsMC01LjQyLDBBNCw0LDAsMCwwLDE3LDE1LjM3YTQsNCwwLDAsMCwxLjExLDIuODIsMy43NCwzLjc0LDAsMCwwLDUuNDUsMCw0LjE5LDQuMTksMCwwLDAsMC01LjY4Wk0yMywxNy42NWEyLjg1LDIuODUsMCwwLDEtMi4xNS45NCwyLjc5LDIuNzksMCwwLDEtMi4xMy0uOTMsMy4yMywzLjIzLDAsMCwxLS44Ni0yLjI2LDMuMywzLjMsMCwwLDEsLjg5LTIuMywyLjgxLDIuODEsMCwwLDEsNC4yNCwwLDMuMjYsMy4yNiwwLDAsMSwuODksMi4yOEEzLjIxLDMuMjEsMCwwLDEsMjMsMTcuNjVaIi8+CiAgPHBvbHlnb24KICAgIHBvaW50cz0iMzYuMjMgMTEuNTQgMzMuODQgMTcuNTUgMzEuMzggMTEuNTQgMzEuMzIgMTEuNTQgMjguODUgMTcuNTUgMjYuNSAxMS41NCAyNS42OCAxMS41NCAyOC44MiAxOS4zNyAyOC44OSAxOS4zNyAzMS4zNSAxMy40MyAzMy44IDE5LjM3IDMzLjg3IDE5LjM3IDM3LjA3IDExLjU0IDM2LjIzIDExLjU0Ii8+CiAgPHBhdGgKICAgIGQ9Ik00NC42OCwxNi44YTMuMTIsMy4xMiwwLDAsMS0yLjg5LDEuODIsMi43MiwyLjcyLDAsMCwxLTItLjg4LDMuMzgsMy4zOCwwLDAsMS0uODgtMi4zMXYtLjA5aDYuNzZhNC4yLDQuMiwwLDAsMC0xLjEzLTIuOTEsMy42NCwzLjY0LDAsMCwwLTIuNjktMS4xLDMuNTEsMy41MSwwLDAsMC0yLjY4LDEuMTgsNC4yNiw0LjI2LDAsMCwwLDAsNS42OCwzLjU3LDMuNTcsMCwwLDAsMi43NCwxLjE4LDMuNzgsMy43OCwwLDAsMCwzLjQ4LTIuMjFaTTM5LDE0LjU1YTIuODMsMi44MywwLDAsMSwyLjg1LTIuNDIsMywzLDAsMCwxLDEuODcuNjQsMi44MywyLjgzLDAsMCwxLDEsMS43OWwwLC4xaC01LjhaIi8+CiAgPHBhdGgKICAgIGQ9Ik01OC4xMywxNi44YTMuMTIsMy4xMiwwLDAsMS0yLjg5LDEuODIsMi43MiwyLjcyLDAsMCwxLTItLjg4LDMuMzgsMy4zOCwwLDAsMS0uODgtMi4zMXYtLjA5aDYuNzZBNC4yLDQuMiwwLDAsMCw1OCwxMi40M2EzLjY0LDMuNjQsMCwwLDAtMi42OS0xLjEsMy41MSwzLjUxLDAsMCwwLTIuNjgsMS4xOCw0LjI2LDQuMjYsMCwwLDAsMCw1LjY4LDMuNTcsMy41NywwLDAsMCwyLjc0LDEuMTgsMy43OCwzLjc4LDAsMCwwLDMuNDgtMi4yMVptLTUuNy0yLjI1YTIuODMsMi44MywwLDAsMSwyLjg1LTIuNDIsMywzLDAsMCwxLDEuODcuNjQsMi44MywyLjgzLDAsMCwxLDEsMS43OWwwLC4xSDUyLjRaIi8+CiAgPHBhdGgKICAgIGQ9Ik02MS44MywxOC4xOGEzLjYxLDMuNjEsMCwwLDAsMi43MywxLjE4LDMuNjgsMy42OCwwLDAsMCwyLjg4LTEuNTZsLjE1LS4xOHYxLjQ4aC43OFY4LjU1aC0uNzh2NC41OGwtLjE1LS4yMWEzLjQ0LDMuNDQsMCwwLDAtMi45Mi0xLjU4LDMuNTksMy41OSwwLDAsMC0yLjY4LDEuMTgsNCw0LDAsMCwwLTEuMTIsMi44M0E0LDQsMCwwLDAsNjEuODMsMTguMThabS41OC01LjFhMywzLDAsMCwxLDQuMzcsMCwzLjI5LDMuMjksMCwwLDEsLjg3LDIuMywzLjE2LDMuMTYsMCwwLDEtLjkzLDIuMzMsMywzLDAsMCwxLTIuMTYuOTIsMi44MiwyLjgyLDAsMCwxLTIuMTMtMSwzLjM3LDMuMzcsMCwwLDEsMC00LjU2WiIvPgogIDxwYXRoCiAgICBkPSJNODAuODksMTIuNTFhMy41NCwzLjU0LDAsMCwwLTIuNjgtMS4xOCwzLjY3LDMuNjcsMCwwLDAtMi45NSwxLjVsLS4xNS4xOFY4LjU1aC0uNzhWMTkuMTFoLjc4VjE3LjVsLjE1LjIxYTMuNSwzLjUsMCwwLDAsMi45MiwxLjY2LDMuNTgsMy41OCwwLDAsMCwyLjY4LTEuMTgsNC4xOCw0LjE4LDAsMCwwLDAtNS42OFptLS42LDUuMWEyLjkyLDIuOTIsMCwwLDEtNC4zNCwwLDMuMzUsMy4zNSwwLDAsMS0uODktMi4zNUEzLjE5LDMuMTksMCwwLDEsNzUuOTQsMTNhMi45MiwyLjkyLDAsMCwxLDIuMTktLjkxLDIuODIsMi44MiwwLDAsMSwyLjE4LDEsMy4zMywzLjMzLDAsMCwxLC44NywyLjI4QTMuMjgsMy4yOCwwLDAsMSw4MC4yOSwxNy42WiIvPgogIDxwb2x5Z29uCiAgICBwb2ludHM9Ijg5LjE5IDExLjU0IDg2LjYzIDE3LjYzIDgzLjk5IDExLjU0IDgzLjE1IDExLjU0IDg2LjIgMTguNjEgODQuNzkgMjEuOTMgODUuNjMgMjEuOTMgOTAuMDQgMTEuNTQgODkuMTkgMTEuNTQiLz4KICA8cmVjdCB4PSI0Ny4zOCIgeT0iMTEuNDkiIHdpZHRoPSIwLjgzIiBoZWlnaHQ9IjcuNzIiLz4KICA8cGF0aAogICAgZD0iTTQ3LjM5LDE0LjA2aC44NGExLjg5LDEuODksMCwwLDEsMS44NS0xLjcyLDEuOCwxLjgsMCwwLDEsLjYyLjEydi0uOWEyLjYzLDIuNjMsMCwwLDAtLjYyLS4wOEEyLjc0LDIuNzQsMCwwLDAsNDcuMzksMTQuMDZaIi8+Cjwvc3ZnPgo=" /></a>
				</div>
			</div>
			<script src="js/jquery-3.3.1.min.js" type="text/javascript" charset="utf-8"></script>
			<script src="js/nebPay.js" type="text/javascript" charset="utf-8"></script>
			<script src="https://cdn.jsdelivr.net/npm/vue"></script>
			<script src="js/layer/layer.js" type="text/javascript" charset="utf-8"></script>
			<script>
				var NebPay = require("nebpay"); //https://github.com/nebulasio/nebPay
				var nebPay = new NebPay();

				//检查扩展是否已安装
				//如果安装了扩展，var“webExtensionWallet”将被注入到web页面中1
				if(typeof(webExtensionWallet) === "undefined") {
					//alert ("扩展钱包未安装，请先安装.")
                    //$("#noExtension").atrr("display", "block");
                    document.getElementById("noExtension").style.display="block";
				}

				var dappAddress = "n222Je7me5V1jpqpFPNVhAhQc4rexLQHmcN";
				var totalSize = 0;
                var page = 0;
				var perpage = 8;
                var myname = "";
                function getLetter(page) {

                    if(page == 0){
                        document.getElementById("prePage").disabled=true;
                    }

                    if(Math.ceil(totalSize/perpage) > page + 1){
                        document.getElementById("nextPage").disabled=false;
                    }
                    else{
                        document.getElementById("nextPage").disabled=true;
                    }

					var to = dappAddress;
					var value = "0";
					var callFunction = "get";
					var callArgs = "[\"" + myname + "\"," + perpage + "," +  page * perpage + "]"; //in the form of ["args"]
					nebPay.simulateCall(to, value, callFunction, callArgs, { //使用nebpay的simulateCall接口去执行get查询, 模拟执行.不发送交易,不上链
						listener: cbSearch //指定回调函数
					});
                }
                
				//return of search,
				function cbSearch(resp) {
					if(!resp.result) return;
					var result = eval(JSON.parse(resp.result));
					if(result !== 'null') {
                        Vue.set(app, 'list', result)
                        if(page > 0){
                            document.getElementById("prePage").disabled=false;
                        }
					}
				}

                // 查询
				function mypush() {
                    if($("#myname").val() == '') {
						layer.alert('名字不能为空哟！');
						return;
                    } 
                    
                    Vue.set(app, 'list', null)
                    document.getElementById("prePage").disabled=true;
                    document.getElementById("nextPage").disabled=true;
					document.getElementById("noone").style.display="none";
					
                    myname = $("#myname").val();
                    page = 0;
                    totalSize = 0;

                    getsize(myname);

                    getLetter(page);
                }

                function getsize(name){
                    var to = dappAddress;
					var value = "0";
					var callFunction = "size";
					var callArgs = "[\"" + name + "\"]"; //in the form of ["args"]
					nebPay.simulateCall(to, value, callFunction, callArgs, { //使用nebpay的simulateCall接口去执行get查询, 模拟执行.不发送交易,不上链
						listener: cbSize //指定回调函数
					});
                }

                function cbSize(resp) {
                    if(!resp.result) 
                        return;

					var result = JSON.parse(resp.result);
					if(result !== 'null') {
                        totalSize = parseInt(result);

						if(totalSize == 0){
							document.getElementById("noone").style.display="block";
						}
                        if(Math.ceil(totalSize/perpage) > page+1){
                            document.getElementById("nextPage").disabled=false;
                        }
					}
                }
                
				// 提交
				function push() {
					if($("#name").val() == '' || $("#word").val() == '') {
						layer.alert('名字和信息不能为空哟！');
						return;
					} 
					var to = dappAddress;
					var value = "0";
					var callFunction = "save"
                    var callArgs = [];
                    callArgs.push($("#name").val());
					callArgs.push($("#word").val());
					nebPay.call(to, value, callFunction, JSON.stringify(callArgs), { //使用nebpay的call接口去调用合约,
						listener: cbPush
					});
				}

				function cbPush(resp) {
					console.log("response of push: " + resp);
					$("#word").val('')
				}

				var app = new Vue({
					el: '#app',
					data: {
						list: []
					},
					methods: {
						formatDateTime: function(theDate) {
							var date = new Date();
							date.setTime(theDate);
							var y = date.getFullYear();
							var m = date.getMonth() + 1;
							m = m < 10 ? ('0' + m) : m;
							var d = date.getDate();
							d = d < 10 ? ('0' + d) : d;
							var h = date.getHours();
							h = h < 10 ? ('0' + h) : h;
							var minute = date.getMinutes();
							var second = date.getSeconds();
							minute = minute < 10 ? ('0' + minute) : minute;
							second = second < 10 ? ('0' + second) : second;
							return y + '-' + m + '-' + d + ' ' + h + ':' + minute + ':' + second;
						},
					}
				})

				$('#prePage').on('click', function() {
                    page -= 1;
                   
					getLetter(page);
				});

				$('#nextPage').on('click', function() {
                    page += 1;
                    
					getLetter(page);
				});
			</script>
		</body>

</html>